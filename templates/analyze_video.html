{% include 'header.html' %}
{% load static %}

<!DOCTYPE html>
<html>
<head>
  <title>Analyze Recorded Video</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
      padding-top: 80px;
    }
    .container {
      margin-top: 40px;
      margin-bottom: 60px;
    }
    .page-title {
      color: #fff;
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    .page-subtitle {
      color: #f0f0f0;
      font-size: 1.1rem;
      text-align: center;
      margin-bottom: 40px;
    }
    .upload-card {
      background-color: #ffffff;
      border-radius: 15px;
      padding: 40px 35px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease;
    }
    .upload-card:hover {
      transform: translateY(-5px);
    }
    .card-title-section {
      font-size: 1.8rem;
      font-weight: 700;
      color: #333;
      text-align: center;
      margin-bottom: 30px;
      position: relative;
    }
    .card-title-section::after {
      content: "";
      display: block;
      width: 80px;
      height: 4px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      margin: 12px auto 0;
      border-radius: 10px;
    }
    .form-label {
      font-weight: 600;
      color: #555;
      margin-bottom: 8px;
    }
    .form-control, .form-select {
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      padding: 12px 15px;
      transition: border-color 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: #667eea;
      box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    .btn-analyze {
      font-size: 1.1rem;
      font-weight: 600;
      padding: 14px 30px;
      border-radius: 8px;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: #fff;
      width: 100%;
      margin-top: 20px;
      transition: transform 0.2s ease;
    }
    .btn-analyze:hover {
      transform: scale(1.02);
      background: linear-gradient(90deg, #764ba2 0%, #667eea 100%);
    }
    .alert {
      border-radius: 10px;
      border: none;
      margin-bottom: 25px;
    }
    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    .file-input-wrapper input[type=file] {
      font-size: 100px;
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
    }
    .file-label {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      background-color: #f8f9fa;
      border: 2px dashed #667eea;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .file-label:hover {
      background-color: #e7e9fc;
    }
    .file-icon {
      font-size: 2rem;
      color: #667eea;
      margin-right: 15px;
    }
    .file-text {
      color: #666;
    }
    .back-link {
      color: #fff;
      text-decoration: none;
      font-size: 1rem;
      display: inline-block;
      margin-bottom: 20px;
      transition: color 0.3s ease;
    }
    .back-link:hover {
      color: #f0f0f0;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="{% url 'run_cameras_page' %}" class="back-link">
      <i class="fas fa-arrow-left"></i> Back to Run Cameras
    </a>
    
    <h1 class="page-title">Analyze Pre-recorded Exam Session</h1>
    <p class="page-subtitle">
      Upload a video file of an exam session to analyze it for potential malpractice behaviors
    </p>

    {% if messages %}
      {% for message in messages %}
        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
          {% if message.tags == 'success' %}
            <i class="fas fa-check-circle"></i>
          {% elif message.tags == 'error' %}
            <i class="fas fa-exclamation-circle"></i>
          {% endif %}
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}

    <div class="row justify-content-center">
      <div class="col-lg-8 col-md-10">
        <div class="upload-card">
          <h2 class="card-title-section">
            <i class="fas fa-cloud-upload-alt"></i> Upload Video
          </h2>
          
          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="mb-4">
              <label for="video_file" class="form-label">
                <i class="fas fa-video"></i> Video File
              </label>
              <div class="file-input-wrapper">
                <label class="file-label" id="file-label">
                  <i class="fas fa-file-video file-icon"></i>
                  <span class="file-text" id="file-text">Click to select video (.mp4, .avi, .mov, etc.)</span>
                </label>
                <input 
                  type="file" 
                  class="form-control" 
                  id="video_file" 
                  name="video_file" 
                  accept="video/*"
                  required
                  onchange="updateFileName(this)">
              </div>
              <small class="text-muted">Supported formats: MP4, AVI, MOV, MKV</small>
            </div>

            <div class="mb-4">
              <label for="hall_id" class="form-label">
                <i class="fas fa-door-open"></i> Select Lecture Hall
              </label>
              <select class="form-select" id="hall_id" name="hall_id" required>
                <option value="" selected disabled>Choose a lecture hall...</option>
                {% for hall in halls %}
                  <option value="{{ hall.id }}">
                    {{ hall.building }} - {{ hall.hall_name }}
                    {% if hall.assigned_teacher %}
                      ({{ hall.assigned_teacher.get_full_name }})
                    {% endif %}
                  </option>
                {% endfor %}
              </select>
            </div>

            <button type="submit" class="btn btn-analyze">
              <i class="fas fa-cogs"></i> Start Analysis
            </button>
          </form>

          <div class="mt-4 p-3" style="background-color: #f8f9fa; border-radius: 8px;">
            <h6 style="color: #667eea; font-weight: 600;">
              <i class="fas fa-info-circle"></i> How it works:
            </h6>
            <ul style="color: #666; font-size: 0.95rem; margin-bottom: 0;">
              <li>Upload your pre-recorded exam session video</li>
              <li>Select the lecture hall where the exam took place</li>
              <li>The AI will analyze the video for suspicious behaviors</li>
              <li>Results will appear in the <a href="{% url 'malpractice_log' %}">Malpractice Log</a></li>
              <li>Detected behaviors: Leaning, Passing Papers, Mobile Phone Usage</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function updateFileName(input) {
      const fileText = document.getElementById('file-text');
      if (input.files && input.files[0]) {
        const fileName = input.files[0].name;
        const fileSize = (input.files[0].size / 1024 / 1024).toFixed(2);
        fileText.textContent = `${fileName} (${fileSize} MB)`;
        fileText.style.color = '#28a745';
        fileText.style.fontWeight = '600';
      } else {
        fileText.textContent = 'Click to select video (.mp4, .avi, .mov, etc.)';
        fileText.style.color = '#666';
        fileText.style.fontWeight = 'normal';
      }
    }
  </script>
</body>
</html>

{% include 'footer.html' %}
